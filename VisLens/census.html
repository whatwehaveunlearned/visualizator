<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
	<script  type="text/javascript" src="js/d3.js"></script>
	<script type="text/javascript" src="js/census_query.js"></script>
	<script type="text/javascript" src="js/census_charts.js"></script>
	<script type="text/javascript" src="js/topojson.v1.min.js"></script>
	<script type="text/javascript" src="js/queue.v1.min.js"></script>

	<style>
		body {
			font-family: sans-serif;
			font-size: 10pt;
		}

		path {
			stroke: #999999;
			stroke-width: .5px;
		}
		path:hover {
			fill: red;
		}
		path.brush {
			stroke: black;
			fill: rgba(210, 210, 210, 0.6);
		}

		.brushText
		{
			font-family: sans-serif;
			font-size: 15px;
			color: black;
			font-weight: bold;
		}

		.brushRect
		{
			stroke: none;
			fill: rgba(255, 255, 255, 0.8);
		}

		.smallLabel
		{
			fony-size: 10pt;
			color: black;
			text-anchor: end;
		}

		svg.placeholder
		{
			position: absolute;
			margin: 0px 0px;
			padding: 0px 0px;
			border: 1px dashed #cccccc;
		}

		.histogramBar
		{
			fill: #999999;
			stroke: none;
		}

	</style>
</head>
<body>
	
	<span id="svgPlaceholder"></span>
	<span id="lensPlaceholder"></span>

	<script type="text/javascript">
		var w = 960;
		var h = 900;
		var maxPercentage = 0;
		var features, featureMap;

		var lensW = 300;
		var lensH = 900;

		// create and append an SVG canvas
		var svg = d3.select("#svgPlaceholder").append("svg")
			.attr("width", w + lensW)
			.attr("height", Math.max(h, lensH))
			.style("left", "10px")
			.style("top", "10px")
			.attr("id", "mainCanvas")
			.classed("placeholder", true);
	
		// create another svg for charts
		/*
		var svgLens = d3.select("#lensPlaceholder").append("svg")
			.attr("width", lensW)
			.attr("height", lensH)
			.style("left", (w + 10 + 10)+"px")
			.style("top", "10px")
			.attr("id", "lensCanvas")
			.classed("placeholder", true);
		*/

		// append a group for charts
		var gMap = svg.append("g");
		var gLens = svg.append("g").attr("transform", "translate("+w+",0)");
		var gBrush = svg.append("g").attr("id", "brushes");


		// create D3 map projection and path generators
		var projection = d3.geo.albersUsa().translate([w/2, h/2]).scale(1200);
		var pathGenerator = d3.geo.path().projection(projection);		
		
		// create the lens object
		var theLens = new LensGrid(gLens, pathGenerator, w, 0);


		

		//var theColors = ["#fff5f0", "#fee0d2", "#fcbba1", "#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#a50f15", "#67000d"]
		var theColors = ['rgb(178,24,43)','rgb(214,96,77)','rgb(244,165,130)','rgb(253,219,199)','rgb(255,255,255)','rgb(224,224,224)','rgb(186,186,186)','rgb(135,135,135)'].reverse();
		//var theColors = ['rgb(178,24,43)','rgb(239,138,98)','rgb(253,219,199)','rgb(247,247,247)','rgb(209,229,240)','rgb(103,169,207)','rgb(33,102,172)'];

		var colorScale = d3.scale.quantize()
			.range(theColors);

		// read TpopJSON file of US counties

		// read census data
		var cs = new CensusQuery();

		// variables we want to get from the census API
		// P0010001: total population
		// P0050003: whites
		var variables = ["P0010001", "P0050003"];

		cs.getCounties(jsonReadCallback, variables);
		function jsonReadCallback(error, json)
		{
			if (error) {
				alert("Error getting census data: " + error);
			}
			else
			{
				// read US counties topoplogy
				d3.json("datasets/us-counties.json", function(error2, topology)
				{
					if (error) {
						alert("Error getting US counties data: " + error2);
						return;
					}
					features = topojson.feature(topology, topology.objects.counties).features;
					
					// make a feature map indexed by county id
					featureMap = d3.map();
					for (var i=0, len=features.length; i < len; i++) {
						featureMap.set(features[i].id, features[i]);
					}
					mashup();
				});
			}

			function mashup()
			{
				var unfound = 0;
				for (var i = 0, len=json.length; i < len; i++)
				{
					// print the data as is
					//console.log(json[i]);

					// figure out percentage of whites
					var datum = json[i];
					var white_percentage = datum.P0050003 / datum.P0010001;

					// what's left is minority
					var minority_percentage = 1.0 - white_percentage;
					if (minority_percentage > maxPercentage)
						maxPercentage = minority_percentage;
				
					// mashup the id of the county with id of the data					
					var geoid = +(datum.state_num + datum.county);
					var theFeature = featureMap.get( geoid );
					if (theFeature) 
					{
						theFeature.properties.value = minority_percentage;
						theFeature.properties.countyName = datum.NAME;
						theFeature.properties.countyNum = datum.county;
						theFeature.properties.geoid = geoid;
						theFeature.properties.stateNum = datum.state_num;
						theFeature.properties.state = datum.state_abbr;
					}
					else
					{
						unfound++
					}
				}
				colorScale.domain([0, maxPercentage]);

				gMap.selectAll("path")
					.data(features)
					.enter().append("path")
					.attr("d", pathGenerator)
					.attr("id", function(d) {return "county_" + d.id;})
					.attr("fill", function(d) {
						var value = d.properties.value;
						if (value) 
							return colorScale(value);
						else
							return "#cccccc";
					})
					.on("mouseover", function() 
					{
						var MAX_DIM = 130;
						var RECT_HEIGHT = 90;
						var RECT_WIDTH = 150;

						var svg = d3.select("#mainCanvas");
						var county = d3.select(this);
						var mouse = d3.mouse(svg.node())
						var geoid = +(county.attr("id").split("_")[1]);
						var feature = featureMap.get(geoid);
						var bounds = pathGenerator.bounds(feature);
						var len = [bounds[1][0]-bounds[0][0], bounds[1][1]-bounds[0][1]];
						var countyScale = MAX_DIM / Math.max(len[0], len[1]);
						len[0] *= countyScale; len[1] *= countyScale; 

						// make a new group to hold the highlight
						var g = svg.append("g")
							.attr("id", "countyOverlay")
							.attr("transform", "translate(" + (mouse[0]+10) + "," + (mouse[1]-10) + ")");

						var countyG = g.append("g").
							attr("transform", "scale("+countyScale+","+countyScale+") translate(-" + bounds[0][0] + ",-" + bounds[0][1] + ")");

						countyG.append("path")
							.classed("brush", true)
							.attr("d", pathGenerator(feature))
							.style("stroke-width", (2/countyScale).toFixed(1) + "px");

						// append text
						var popY = 0;
						g.append("rect")
							.attr("x", "0").attr("y", popY-RECT_HEIGHT)
							.attr("width", RECT_WIDTH).attr("height", RECT_HEIGHT)
							.classed("brushRect", true);
						popY -= 5+25;
						
						var BAR_OFFSET = 60;
						var BAR_HEIGHT = 10;
						var BAR_WIDTH_MAX = RECT_WIDTH - BAR_OFFSET - 10;
						g.append("text").text("whites").classed("smallLabel", true).attr("y", popY).attr("x", BAR_OFFSET-5);
						var whites = g.append("rect").classed("barchart", true).attr("y", popY-BAR_HEIGHT).attr("x", BAR_OFFSET).attr("height", BAR_HEIGHT).attr("width", 0);
						popY -= 15;

						g.append("text").text("blacks").classed("smallLabel", true).attr("y", popY).attr("x", BAR_OFFSET-5);
						var blacks = g.append("rect").classed("barchart", true).attr("y", popY-BAR_HEIGHT).attr("x", BAR_OFFSET).attr("height", BAR_HEIGHT).attr("width", 0)
						popY -= 15;

						g.append("text").text("asians").classed("smallLabel", true).attr("y", popY).attr("x", BAR_OFFSET-5);
						var asians = g.append("rect").classed("barchart", true).attr("y", popY-BAR_HEIGHT).attr("x", BAR_OFFSET).attr("height", BAR_HEIGHT).attr("width", 0)
						popY -= 15;

						g.append("text").text("hispanics").classed("smallLabel", true).attr("y", popY).attr("x", BAR_OFFSET-5);
						var hispanics = g.append("rect").classed("barchart", true).attr("y", popY-BAR_HEIGHT).attr("x", BAR_OFFSET).attr("height", BAR_HEIGHT).attr("width", 0)
						popY -= 15;

						g.append("text")
							.text(feature.properties.countyName + ", " + feature.properties.state)
							.attr("y", "-10")
							.classed("brushText", true);

						// send an ajax query
						var cq = new CensusQuery()
						cq.getCounties(
							function(error, json)
							{
								if (error) return;
								var response = json[0];
								var d = [+response.P0060002, +response.P0060003, +response.P0060005, +response.P0040003];
								var theMax = d3.max(d);
								whites.transition().attr("width", BAR_WIDTH_MAX * response.P0060002 / theMax)
								blacks.transition().attr("width", BAR_WIDTH_MAX * response.P0060003 / theMax)
								asians.transition().attr("width", BAR_WIDTH_MAX * response.P0060005 / theMax)
								hispanics.transition().attr("width", BAR_WIDTH_MAX * response.P0040003 / theMax)
							},
							["P0060002", "P0060003", "P0060005", "P0040003"], feature.properties.state, feature.properties.countyNum
						);

						theLens.addSelectionLink(geoid);

					})
					.on("mousemove", function() 
					{
						var mouse = d3.mouse(d3.select("#mainCanvas").node());
						d3.select("#countyOverlay").attr("transform", "translate(" + (mouse[0]+10) + "," + (mouse[1]-10) + ")");
					})
					.on("mouseout", function() {
						theLens.removeSelectionLink();
						d3.select("#countyOverlay").remove();
					})
					.on("dblclick", function() 
					{
						var clickedCounty = d3.select(this);
						var geoid = +clickedCounty.attr("id").split("_")[1];
						var feature = featureMap.get(geoid);
						theLens.addCounty(feature.properties.countyNum, feature.properties.state, feature);
					});
			}

		}




	</script>
</body>
</html>